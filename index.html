<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VR Box - Cubo con Botón C</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    .a-enter-vr-button {
      background: #2E7D32 !important;
      border-radius: 12px !important;
      padding: 16px 32px !important;
      font-size: 18px !important;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4) !important;
    }
  </style>
</head>
<body>

  <!-- ESCENA A-FRAME -->
  <a-scene 
    embedded
    vr-mode-ui="enabled: true"
    device-orientation-permission-ui="enabled: false"
    background="color: #87CEEB"
  >

    <!-- Cámara -->
    <a-camera id="camera" position="0 1.6 0"></a-camera>

    <!-- Cubo -->
    <a-box 
      id="cubo"
      position="0 1 -2.5"
      width="0.6" height="0.6" depth="0.6"
      color="#FF5722"
      shadow
    ></a-box>

    <!-- Suelo -->
    <a-plane 
      position="0 0 -4" 
      rotation="-90 0 0" 
      width="12" height="12" 
      color="#43A047"
      shadow
    ></a-plane>

    <!-- Luces -->
    <a-light type="ambient" intensity="0.7"></a-light>
    <a-light type="directional" position="5 10 5" intensity="0.9"></a-light>

  </a-scene>

  <!-- LÓGICA: BOTÓN C (25) + JOYSTICK -->
  <script>
    const cubo = document.getElementById('cubo');
    const camera = document.getElementById('camera');
    let isGrabbing = false;
    let gamepad = null;

    // Escanear gamepad
    setInterval(() => {
      const gps = navigator.getGamepads();
      for (let gp of gps) {
        if (gp && gp.connected) {
          gamepad = gp;
          break;
        }
      }
    }, 200);

    // BOTÓN C (índice 25): Agarrar
    window.addEventListener('gamepadbuttondown', (e) => {
      if (e.buttonIndex === 25 && !isGrabbing) {
        const camPos = camera.getAttribute('position');
        const cubePos = cubo.getAttribute('position');
        const dist = camPos.distanceTo(cubePos);
        if (dist < 4) {
          isGrabbing = true;
          cubo.setAttribute('material', 'color', '#FF9800');
          cubo.setAttribute('animation', 'property: scale; to: 1.2 1.2 1.2; dur: 200');
        }
      }
    });

    // BOTÓN C: Soltar
    window.addEventListener('gamepadbuttonup', (e) => {
      if (e.buttonIndex === 25 && isGrabbing) {
        isGrabbing = false;
        cubo.setAttribute('material', 'color', '#FF5722');
        cubo.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 200');
      }
    });

    // MOVIMIENTO CON JOYSTICK
    AFRAME.registerComponent('c-joystick-movement', {
      tick: function () {
        if (!gamepad || !isGrabbing) return;

        const axisX = gamepad.axes[0] || 0;
        const axisY = gamepad.axes[1] || 0;

        if (Math.abs(axisX) < 0.15 && Math.abs(axisY) < 0.15) return;

        const speed = 5.0;
        const delta = this.el.sceneEl.delta / 1000;
        const pos = cubo.getAttribute('position');

        cubo.setAttribute('position', {
          x: pos.x + axisX * speed * delta,
          y: pos.y,
          z: pos.z - axisY * speed * delta
        });
      }
    });

    cubo.setAttribute('c-joystick-movement', '');
  </script>

</body>
</html>
