<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VR Box + Botón VR Oficial</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- aframe-extras (para gamepad) -->
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    #info {
      position: fixed;
      top: 20px;
      left: 20px;
      color: white;
      background: rgba(0,0,0,0.6);
      padding: 12px;
      border-radius: 10px;
      font-size: 16px;
      z-index: 1000;
      font-family: sans-serif;
    }
    /* El botón VR lo maneja A-Frame, pero puedes personalizarlo */
    .a-enter-vr-button {
      background: #2E7D32 !important;
      border-radius: 12px !important;
      padding: 16px 32px !important;
      font-size: 20px !important;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4) !important;
    }
  </style>
</head>
<body>

  <div id="info">
    Conecta tu mando Bluetooth<br>
    <strong>Botón A</strong>: Agarrar<br>
    <strong>Joystick</strong>: Mover cubo
  </div>

  <!-- ESCENA A-FRAME -->
  <a-scene 
    embedded
    vr-mode-ui="enabled: true"  <!-- Habilita el botón VR oficial -->
    device-orientation-permission-ui="enabled: false"
    background="color: #87CEEB"
  >

    <!-- Cámara -->
    <a-camera id="camera"></a-camera>

    <!-- Cubo -->
    <a-box 
      id="cubo"
      position="0 1.6 -2"
      width="0.5" height="0.5" depth="0.5"
      color="#FF5722"
      shadow
      vrbox-joystick-movement
    ></a-box>

    <!-- Suelo -->
    <a-plane 
      position="0 0 -2" 
      rotation="-90 0 0" 
      width="10" height="10" 
      color="#43A047"
      shadow
    ></a-plane>

    <!-- Luces -->
    <a-light type="ambient" intensity="0.6"></a-light>
    <a-light type="directional" position="5 10 5"></a-light>

  </a-scene>

  <!-- COMPONENTE: Mover con Joystick del mando VR Box -->
  <script>
    AFRAME.registerComponent('vrbox-joystick-movement', {
      init: function () {
        this.gamepad = null;
        this.isGrabbing = false;
        this.grabbedObject = null;

        // Detectar gamepad
        this.findGamepad = setInterval(() => {
          const gps = navigator.getGamepads();
          for (let gp of gps) {
            if (gp && gp.connected) {
              this.gamepad = gp;
              break;
            }
          }
        }, 500);
      },

      tick: function () {
        if (!this.gamepad || !this.isGrabbing || !this.grabbedObject) return;

        const axisX = this.gamepad.axes[0] || 0;
        const axisY = this.gamepad.axes[1] || 0;

        if (Math.abs(axisX) < 0.2 && Math.abs(axisY) < 0.2) return;

        const speed = 3.0;
        const delta = this.el.sceneEl.delta / 1000;
        const pos = this.grabbedObject.getAttribute('position');

        this.grabbedObject.setAttribute('position', {
          x: pos.x + axisX * speed * delta,
          y: pos.y,
          z: pos.z - axisY * speed * delta
        });
      }
    });

    // --- CONTROL CON BOTÓN A (agarrar/soltar) ---
    let isGrabbing = false;
    let grabbedObject = null;
    const cubo = document.getElementById('cubo');

    window.addEventListener('gamepadbuttondown', (e) => {
      if (e.buttonIndex === 0) { // Botón A
        if (!isGrabbing && cubo) {
          // Simular "agarre" si el cubo está cerca
          const camPos = document.querySelector('a-camera').getAttribute('position');
          const cubePos = cubo.getAttribute('position');
          const dist = camPos.distanceTo(cubePos);
          if (dist < 2.5) {
            isGrabbing = true;
            grabbedObject = cubo;
            cubo.setAttribute('material', 'color', '#FF9800');
            cubo.components['vrbox-joystick-movement'].isGrabbing = true;
            cubo.components['vrbox-joystick-movement'].grabbedObject = cubo;
          }
        }
      }
    });

    window.addEventListener('gamepadbuttonup', (e) => {
      if (e.buttonIndex === 0 && isGrabbing) {
        isGrabbing = false;
        grabbedObject = null;
        cubo.setAttribute('material', 'color', '#FF5722');
        cubo.components['vrbox-joystick-movement'].isGrabbing = false;
        cubo.components['vrbox-joystick-movement'].grabbedObject = null;
      }
    });

    // --- SALIR DE VR CON DOBLE TOQUE O BOTÓN ATRÁS ---
    let tapCount = 0;
    document.addEventListener('backbutton', () => {
      const scene = document.querySelector('a-scene');
      if (scene.is('vr-mode')) {
        scene.exitVR();
      }
    });

    // Doble toque en pantalla para salir (opcional)
    document.addEventListener('touchstart', () => {
      tapCount++;
      setTimeout(() => tapCount = 0, 500);
      if (tapCount >= 2) {
        const scene = document.querySelector('a-scene');
        if (scene.is('vr-mode')) scene.exitVR();
      }
    });
  </script>

</body>
</html>
