<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VR Box - Gatillo (4) + Joystick</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.8);
      padding: 12px;
      border-radius: 10px;
      font-size: 16px;
      z-index: 1000;
      font-family: monospace;
      max-width: 300px;
    }
    .a-enter-vr-button {
      background: #2E7D32 !important;
      border-radius: 15px !important;
      padding: 20px 40px !important;
      font-size: 22px !important;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4) !important;
    }
  </style>
</head>
<body>

  <div id="debug">
    üîå Conecta mando Bluetooth<br>
    üéÆ Gatillo (bot√≥n 4): Agarrar/Soltar<br>
    üïπÔ∏è Joystick: Mover
  </div>

  <!-- ESCENA A-FRAME -->
  <a-scene 
    embedded
    vr-mode-ui="enabled: true"
    device-orientation-permission-ui="enabled: false"
    background="color: #87CEEB"
  >

    <!-- C√°mara -->
    <a-camera id="camera" position="0 1.6 0"></a-camera>

    <!-- Cubo GRANDE y visible -->
    <a-box 
      id="cubo"
      position="0 1.2 -1.5"
      width="0.8" height="0.8" depth="0.8"
      color="#FF5722"
      shadow
    ></a-box>

    <!-- Suelo -->
    <a-plane 
      position="0 0 -4" 
      rotation="-90 0 0" 
      width="15" height="15" 
      color="#43A047"
      shadow
    ></a-plane>

    <!-- Luces -->
    <a-light type="ambient" intensity="0.7"></a-light>
    <a-light type="directional" position="5 10 5" intensity="0.9"></a-light>

  </a-scene>

  <!-- SCRIPT: GATILLO (4) + JOYSTICK -->
  <script>
    const scene = document.querySelector('a-scene');
    const debug = document.getElementById('debug');
    const cubo = document.getElementById('cubo');
    const camera = document.getElementById('camera');

    let isGrabbing = false;
    let gamepad = null;

    // Debug en tiempo real
    function updateDebug() {
      const gps = navigator.getGamepads();
      let text = 'üîå Conecta mando...<br>';
      
      for (let i = 0; i < gps.length; i++) {
        const gp = gps[i];
        if (gp && gp.connected) {
          gamepad = gp;
          text = `‚úÖ Mando: ${gp.id.substring(0,20)}...<br>`;
          text += `üéÆ Gatillo(4): ${gp.buttons[4]?.pressed ? 'PRESIONADO' : 'libre'}<br>`;
          text += `üïπÔ∏è Joystick: X=${(gp.axes[0]||0).toFixed(1)} Y=${(gp.axes[1]||0).toFixed(1)}<br>`;
          text += `üì¶ Cubo: ${isGrabbing ? 'üü† AGARRADO' : 'üî¥ Libre'}`;
          break;
        }
      }
      debug.innerHTML = text;
    }

    setInterval(updateDebug, 100);

    // GATILLO (BOT√ìN 4) - Agarrar
    window.addEventListener('gamepadbuttondown', (e) => {
      if (e.buttonIndex === 4) {  // ¬°GATILLO!
        console.log('üî´ GATILLO PRESIONADO');
        
        if (!isGrabbing) {
          // Verificar distancia (m√°s f√°cil)
          const camPos = camera.getAttribute('position');
          const cubePos = cubo.getAttribute('position');
          const dist = camPos.distanceTo(cubePos);
          
          if (dist < 4) {  // Muy amplio
            isGrabbing = true;
            cubo.setAttribute('material', 'color', '#FF9800');  // Naranja
            cubo.setAttribute('scale', '1.1 1.1 1.1');  // M√°s grande
            console.log('‚úÖ CUBO AGARRADO');
          }
        }
      }
    });

    // GATILLO (BOT√ìN 4) - Soltar
    window.addEventListener('gamepadbuttonup', (e) => {
      if (e.buttonIndex === 4 && isGrabbing) {
        isGrabbing = false;
        cubo.setAttribute('material', 'color', '#FF5722');  // Rojo
        cubo.setAttribute('scale', '1 1 1');  // Normal
        console.log('‚úÖ CUBO SOLTADO');
      }
    });

    // MOVIMIENTO CON JOYSTICK (solo cuando agarrado)
    AFRAME.registerComponent('joystick-mover', {
      tick: function () {
        if (!isGrabbing || !gamepad) return;

        const axisX = gamepad.axes[0] || 0;
        const axisY = gamepad.axes[1] || 0;

        // Deadzone mejorado
        if (Math.abs(axisX) < 0.15 && Math.abs(axisY) < 0.15) return;

        const speed = 5.0;  // R√°pido
        const delta = this.el.sceneEl.delta / 1000;

        const pos = cubo.getAttribute('position');

        // Mover en plano XZ (horizontal)
        cubo.setAttribute('position', {
          x: pos.x + axisX * speed * delta,
          y: pos.y,  // Altura fija
          z: pos.z - axisY * speed * delta  // Invertido: joystick arriba = hacia adelante
        });
      }
    });

    cubo.setAttribute('joystick-mover', {});

    // Rotaci√≥n opcional con otro bot√≥n (bot√≥n 5 si existe)
    window.addEventListener('gamepadbuttondown', (e) => {
      if (e.buttonIndex === 5 && isGrabbing) {  // Bot√≥n 5 (si tienes)
        const rotation = cubo.getAttribute('rotation');
        cubo.setAttribute('rotation', {
          x: rotation.x,
          y: rotation.y + 90,
          z: rotation.z
        });
      }
    });

    console.log('üöÄ Listo! Gatillo=4, Joystick=axes[0,1]');
  </script>

</body>
</html>
