<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Minijuego VR</title>
<style>
  body { margin: 0; overflow: hidden; background: #000; }
  canvas { display: block; }
</style>
</head>
<body>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";
import { VRButton } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/webxr/VRButton.js";

let scene, camera, renderer;
let score = 0;
let scoreText;
let rings = [];
let playing = false;

init();
function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
  camera.position.set(0, 1.6, 0);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  document.body.appendChild(VRButton.createButton(renderer));
  renderer.xr.addEventListener("sessionstart", startGame);

  createScoreText();

  animate();
}

// ⭐ Texto dentro del 3D (puntaje)
function createScoreText() {
  const spriteCanvas = document.createElement("canvas");
  spriteCanvas.width = 512;
  spriteCanvas.height = 256;
  const ctx = spriteCanvas.getContext("2d");

  function drawScore() {
    ctx.clearRect(0, 0, 512, 256);
    ctx.fillStyle = "white";
    ctx.font = "60px Arial";
    ctx.fillText("Puntaje: " + score, 50, 140);
    scoreText.material.map.needsUpdate = true;
  }

  const texture = new THREE.CanvasTexture(spriteCanvas);
  const material = new THREE.SpriteMaterial({ map: texture });
  scoreText = new THREE.Sprite(material);
  scoreText.scale.set(2.5, 1.2, 1);
  scoreText.position.set(0, 2.3, -3);

  scene.add(scoreText);

  // Actualizar score cada vez
  scoreText.redraw = drawScore;
  drawScore();
}

// ⭐ Crear un aro
function createRing() {
  const geometry = new THREE.TorusGeometry(0.4, 0.08, 16, 100);
  const material = new THREE.MeshStandardMaterial({ color: 0x00ffcc });

  const ring = new THREE.Mesh(geometry, material);
  ring.position.set(
    (Math.random() * 1.0 - 0.5),   // movimiento suave en X
    1.6 + (Math.random() * 0.3 - 0.15), // movimiento leve vertical
    -10
  );

  ring.rotation.x = Math.PI / 2;

  scene.add(ring);
  rings.push(ring);
}

// ⭐ Luces
const light1 = new THREE.HemisphereLight(0xffffff, 0x222222, 1);
scene.add(light1);

const light2 = new THREE.DirectionalLight(0xffffff, 0.6);
light2.position.set(5, 10, 7);
scene.add(light2);

// ⭐ Empieza cuando entra en VR
function startGame() {
  playing = true;
  score = 0;
  rings = [];

  // Crear nuevos aros cada 1.3s
  setInterval(() => {
    if (!playing) return;
    createRing();
  }, 1300);

  // Texto grande al iniciar
  createStartText();
}

function createStartText() {
  const canvas = document.createElement("canvas");
  canvas.width = 1024;
  canvas.height = 512;
  const ctx = canvas.getContext("2d");

  ctx.fillStyle = "white";
  ctx.font = "80px Arial";
  ctx.fillText("¡Toma los aros!", 200, 250);

  const texture = new THREE.CanvasTexture(canvas);
  const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
  sprite.position.set(0, 1.8, -2.5);
  sprite.scale.set(4, 2, 1);
  scene.add(sprite);

  setTimeout(() => scene.remove(sprite), 2000);
}

// ⭐ Detección de colisión con leve movimiento de cabeza
function checkRingCollision(ring) {
  const ringPos = new THREE.Vector3().setFromMatrixPosition(ring.matrixWorld);
  const headPos = new THREE.Vector3().setFromMatrixPosition(camera.matrixWorld);

  const dx = ringPos.x - headPos.x;
  const dy = ringPos.y - headPos.y;
  const dz = ringPos.z - headPos.z;

  const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

  return dist < 0.45;
}

function animate() {
  renderer.setAnimationLoop(() => {
    
    if (playing) {
      // Mover aros hacia adelante siempre
      rings.forEach((ring, i) => {
        ring.position.z += 0.05;

        // Si lo toma → puntaje
        if (checkRingCollision(ring)) {
          score++;
          scoreText.redraw();
          scene.remove(ring);
          rings.splice(i, 1);
        }

        // Si pasa al jugador → borrar
        if (ring.position.z > 1) {
          scene.remove(ring);
          rings.splice(i, 1);
        }
      });
    }

    renderer.render(scene, camera);
  });
}

</script>
</body>
</html>
